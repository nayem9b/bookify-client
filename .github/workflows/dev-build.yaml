name: Dev Build & Artifact

on:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "package.json"
      - "Dockerfile"
      - ".github/workflows/dev-build.yaml"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  packages: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
      build-timestamp: ${{ steps.timestamp.outputs.timestamp }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

      # Set up Node.js for package.json update
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # Generate version based on commit count
      - name: Generate version
        id: version
        run: |
          LATEST_TAG=$(git tag -l --sort=-v:refname | head -n 1)

          if [ -z "$LATEST_TAG" ] || ! [[ "$LATEST_TAG" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            LATEST_TAG="0.0.0"
          fi

          CLEAN_TAG=${LATEST_TAG#v}
          MAJOR=$(echo $CLEAN_TAG | cut -d. -f1)
          MINOR=$(echo $CLEAN_TAG | cut -d. -f2)
          PATCH=$(echo $CLEAN_TAG | cut -d. -f3)

          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version: $NEW_VERSION"

      # Update package.json with new version
      - name: Update package.json version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          if [ "$CURRENT_VERSION" != "$NEW_VERSION" ]; then
            npm version $NEW_VERSION --no-git-tag-version
            git add package.json package-lock.json
            git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
            git push
            echo "✓ Version updated from $CURRENT_VERSION to $NEW_VERSION"
          else
            echo "✓ Version already at $NEW_VERSION, skipping update"
          fi

      - name: Generate timestamp
        id: timestamp
        run: echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      # Install dependencies
      - name: Install dependencies
        run: npm install

      # # Run tests
      # - name: Run tests
      #   continue-on-error: true
      #   run: npm test -- --watchAll=false --passWithNoTests

      # Build the application
      - name: Build application
        run: npm run build
        env:
          CI: false

      # Create artifact from build output
      - name: Create build artifact
        run: |
          cd build
          tar -czf ../bookify-client-${{ steps.version.outputs.new_version }}.tar.gz .
          cd ..

      # Upload artifact to GitHub
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: bookify-client-${{ steps.version.outputs.new_version }}
          path: bookify-client-${{ steps.version.outputs.new_version }}.tar.gz
          retention-days: 30

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Log in to Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      # Build and push Docker image to staging
      - name: Build and push Docker image (dev)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ steps.version.outputs.new_version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-latest
          labels: |
            org.opencontainers.image.version=${{ steps.version.outputs.new_version }}
            org.opencontainers.image.revision=${{ github.sha }}
            build.timestamp=${{ steps.timestamp.outputs.timestamp }}

      # Trigger staging deployment
      - name: Trigger staging deployment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'staging-qa-release.yaml',
              ref: 'main',
              inputs: {
                version: '${{ steps.version.outputs.new_version }}',
                docker_tag: 'dev-${{ steps.version.outputs.new_version }}'
              }
            })

      # Summary
      - name: Print build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Timestamp**: ${{ steps.timestamp.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact**: bookify-client-${{ steps.version.outputs.new_version }}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
